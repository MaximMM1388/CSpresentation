<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kahoot! | Join Game</title>
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; }
        body { overflow: hidden; height: 100vh; width: 100vw; background: #f2f2f2; }

        /* --- UI LAYERS --- */
        .layer { display: none; height: 100vh; width: 100vw; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; }

        /* --- 1. STUDENT: KAHOOT LOOK --- */
        #game-ui { display: flex; background: #f2f2f2; }
        .q-box { background: white; padding: 30px; border-radius: 5px; box-shadow: 0 5px 0 #ccc; width: 90%; max-width: 600px; text-align: center; font-weight: bold; font-size: 1.5rem; margin-bottom: 20px; }
        .ans-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 95%; height: 40%; }
        .btn { border: none; color: white; font-weight: bold; font-size: 1.2rem; border-radius: 4px; cursor: pointer; display: flex; align-items: center; padding: 20px; }
        .red { background: #e21b3c; } .blue { background: #1368ce; } .yellow { background: #d89e00; } .green { background: #26890c; }

        /* --- 2. SCARE: THE TRAP --- */
        #scare-ui { background: black; color: red; text-align: center; }
        .glitch { font-size: 2.5rem; font-weight: 900; border: 4px solid red; padding: 20px; animation: flash 0.2s infinite; }
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .ip-box { background: #222; color: white; padding: 15px; margin-top: 20px; font-family: monospace; font-size: 1.5rem; }

        /* --- 3. LESSONS: RELAX --- */
        #lesson-ui { background: white; color: #333; padding: 30px; text-align: center; }
        
        /* --- 4. TEACHER: REMOTE PANEL --- */
        #teacher-controls { 
            position: fixed; top: 10px; left: 10px; background: rgba(255,255,255,0.9); 
            border: 3px solid #46178f; padding: 15px; z-index: 9999; display: none;
            border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .t-btn { display: block; width: 100%; margin: 5px 0; padding: 10px; background: #46178f; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .t-btn.danger { background: red; }
    </style>
</head>
<body>

    <div id="teacher-controls">
        <h3 style="color:#46178f; margin-bottom:10px;">Teacher Remote</h3>
        <button class="t-btn danger" onclick="send('SCARE')">1. TRIGGER SCARE</button>
        <button class="t-btn" onclick="send('L1')">2. SHOW LESSON 1</button>
        <button class="t-btn" onclick="send('L2')">3. SHOW LESSON 2</button>
        <button class="t-btn" onclick="location.reload()">Reset Everything</button>
    </div>

    <div id="game-ui" class="layer">
        <div class="q-box">Cyber-Security Quiz:<br>Which is the safest connection?</div>
        <div class="ans-grid">
            <button class="btn red">‚ñ≤ Public WiFi</button>
            <button class="btn blue">‚óÜ This Quiz</button>
            <button class="btn yellow">‚óè Admin123</button>
            <button class="btn green">‚ñ† Password123</button>
        </div>
    </div>

    <div id="scare-ui" class="layer">
        <div style="font-size: 5rem;">üíÄ</div>
        <div class="glitch">SOCIALLY ENGINEERED</div>
        <div class="ip-box" id="ip-addr">TRACING IP...</div>
        <p style="margin-top:20px;">ACCESSING CAMERA... UPLOADING DATA...</p>
    </div>

    <div id="lesson-ui" class="layer">
        <h1 id="lesson-title" style="color:#46178f; font-size: 3rem;"></h1>
        <p id="lesson-text" style="font-size: 1.5rem; margin-top: 20px; max-width: 600px;"></p>
    </div>

    <script>
        // --- CONFIG ---
        const ably = new Ably.Realtime('whyK0Q.-8H0rA:_SQSQ2DWPa-nW0h3XbnGBT-yyOE4QrIt6uVLDu-aoEM'); 
        const channel = ably.channels.get('cyber-room');
        const params = new URLSearchParams(window.location.search);

        // --- IP DETECTION ---
        let userIP = "0.0.0.0";
        fetch('https://api.ipify.org?format=json').then(r => r.json()).then(d => userIP = d.ip);

        // --- TEACHER LOGIC ---
        if (params.has('teacher')) {
            document.getElementById('teacher-controls').style.display = 'block';
        }

        function send(cmd) { channel.publish('cmd', { type: cmd }); }

        // --- STUDENT LOGIC (Receiving Commands) ---
        channel.subscribe('cmd', (msg) => {
            const type = msg.data.type;
            hideAll();

            if (type === 'SCARE') {
                document.getElementById('scare-ui').style.display = 'flex';
                document.getElementById('ip-addr').innerText = userIP;
                // Try to force fullscreen on the students' devices
                document.documentElement.requestFullscreen().catch(()=>{});
            } 
            else if (type === 'L1') {
                showLesson("Lesson 1: Visual Trust", "You clicked because it looked like Kahoot. Hackers use 'Brand Spoofing' to steal passwords.");
            }
            else if (type === 'L2') {
                showLesson("Lesson 2: Passive Data", "I didn't ask for your IP, but your browser gave it to me anyway. Always use a VPN.");
            }
        });

        function hideAll() {
            document.querySelectorAll('.layer').forEach(l => l.style.display = 'none');
        }

        function showLesson(title, text) {
            document.getElementById('lesson-ui').style.display = 'flex';
            document.getElementById('lesson-title').innerText = title;
            document.getElementById('lesson-text').innerText = text;
        }
    </script>
</body>
</html>